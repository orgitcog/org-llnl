# Copyright 2023 Lawrence Livermore National Security, LLC and other
# Benchpark Project Developers. See the top-level COPYRIGHT file for details.
#
# Copyright 2013-2023 Spack Project Developers.
#
# SPDX-License-Identifier: Apache-2.0

import os
import pickle
import shutil
import sys

import benchpark.spec
from benchpark.error import BenchparkError


def experiment_init(args):
    experiment_spec = benchpark.spec.ExperimentSpec(" ".join(args.spec)).concretize()
    experiment = experiment_spec.experiment

    if not os.path.exists(args.system):
        raise BenchparkError(
            f"System '{args.system}' does not exist. Run 'benchpark system init --dest {args.system} ...'."
        )
    system_file = os.path.join(args.system, "system.pkl")
    with open(system_file, "rb") as f:
        system_spec = pickle.load(f)

    experiment.system_spec = system_spec

    if args.dest:
        experiment_component = args.dest
    else:
        experiment_component = experiment_spec.name

    destdir = os.path.join(args.system, experiment_component)

    try:
        os.makedirs(destdir)
        experiment.write_ramble_dict(f"{destdir}/ramble.yaml")
        print(
            f"Run `benchpark setup {destdir} <experiments_root>` to generate Ramble workspace"
        )
    except FileExistsError:
        print(f"Abort: experiment description dir already exists ({destdir})")
        sys.exit(1)
    except Exception:
        # If there was a failure, remove any partially-generated resources
        shutil.rmtree(destdir)
        raise


def setup_parser(root_parser):
    system_subparser = root_parser.add_subparsers(
        dest="experiment_subcommand", required=True
    )

    init_parser = system_subparser.add_parser("init")
    init_parser.add_argument("--dest", help="Place all system files here directly")
    init_parser.add_argument(
        "system",
        help="The system this experiment will run on (directory generated by 'benchpark system init')",
    )

    init_parser.add_argument("spec", nargs="+", help="Experiment spec")


def command(args):
    actions = {
        "init": experiment_init,
    }
    if args.experiment_subcommand in actions:
        actions[args.experiment_subcommand](args)
