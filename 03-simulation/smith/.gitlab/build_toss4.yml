####
# This is the shared configuration of jobs for toss4
.on_toss4:
  variables:
    SCHEDULER_PARAMETERS: "--reservation=ci --exclusive=user --deadline=now+${ALLOC_DEADLINE}minutes -N ${ALLOC_NODES} -t ${ALLOC_TIME} -A ${ALLOC_BANK}"
    ALLOC_DEADLINE: "180" # Allocation times must be less than this value
  tags:
    - batch
    - dane
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /_qnone/ || $ON_TOSS4 == "OFF"' #run except if ...
      when: never
  before_script:
    # We could also extract the CMake executable location from the hostconfig in common_build_functions
    # like we do in config-build
    - module load cmake/3.23.1
    - module load texlive

####
# Templates
.src_build_on_toss4:
  extends: [.src_build_script, .on_toss4, .src_workflow]

.examples_build_on_toss4:
  extends: [.examples_build_script, .on_toss4, .examples_workflow]

.tpl_build_on_toss4:
  extends: [.tpl_build_script, .on_toss4, .tpl_workflow]
  before_script:
    # LC version of pip is ancient
    - if [[ $(python3 -c 'import pip; print(pip.__version__ < "19.3")') == "True" ]]; then python3 -m pip install --user --upgrade pip; fi

.benchmarks_build_on_toss4:
  extends: [.benchmarks_build_script, .on_toss4, .benchmarks_workflow]

.comparison_build_on_toss4:
  extends: [.comparison_build_script, .on_toss4, .comparison_workflow]

####
# Build jobs

toss4-llvm_19_1_3-src:
  variables:
    COMPILER: "llvm@19.1.3"
    HOST_CONFIG: "dane-toss_4_x86_64_ib-${COMPILER}.cmake"
    EXTRA_CMAKE_OPTIONS: "-DENABLE_BENCHMARKS=ON -DENABLE_DOCS=OFF -DCMAKE_BUILD_TYPE=Debug -DSMITH_USE_DFEM=ON"
    # Only run integration tests on one spec (Disabled until integration tests are reenabled)
    # DO_INTEGRATION_TESTS: "yes"
    # ALLOC_NODES: "2"
    ALLOC_NODES: "1"
    ALLOC_TIME: "30"
  extends: .src_build_on_toss4

toss4-llvm_19_1_3-src-codevelop:
  variables:
    COMPILER: "llvm@19.1.3"
    HOST_CONFIG: "dane-toss_4_x86_64_ib-${COMPILER}.cmake"
    EXTRA_CMAKE_OPTIONS: "-DENABLE_BENCHMARKS=ON -DENABLE_DOCS=OFF -DCMAKE_BUILD_TYPE=Debug -DSMITH_ENABLE_CODEVELOP=ON -DSMITH_USE_DFEM=ON"
    EXTRA_BUILD_OPTIONS: "--skip-install"
    ALLOC_NODES: "1"
    ALLOC_TIME: "30"
  extends: .src_build_on_toss4

toss4-gcc_13_3_1-src:
  variables:
    COMPILER: "gcc@13.3.1"
    HOST_CONFIG: "dane-toss_4_x86_64_ib-${COMPILER}.cmake"
    EXTRA_CMAKE_OPTIONS: "-DENABLE_BENCHMARKS=ON -DENABLE_DOCS=OFF -DCMAKE_BUILD_TYPE=Debug"
    ALLOC_NODES: "1"
    ALLOC_TIME: "30"
  extends: .src_build_on_toss4

toss4-gcc_13_3_1-src-no-tribol:
  variables:
    COMPILER: "gcc@13.3.1"
    HOST_CONFIG: "dane-toss_4_x86_64_ib-${COMPILER}.cmake"
    EXTRA_CMAKE_OPTIONS: "-DENABLE_BENCHMARKS=ON -DENABLE_DOCS=OFF -DCMAKE_BUILD_TYPE=Debug -UTRIBOL_DIR"
    ALLOC_NODES: "1"
    ALLOC_TIME: "30"
  extends: .src_build_on_toss4

toss4-gcc_13_3_1-src-no-optional-solvers:
  variables:
    COMPILER: "gcc@13.3.1"
    HOST_CONFIG: "dane-toss_4_x86_64_ib-${COMPILER}.cmake"
    EXTRA_CMAKE_OPTIONS: "-DENABLE_BENCHMARKS=ON -DENABLE_DOCS=OFF -DCMAKE_BUILD_TYPE=Debug -USUNDIALS_DIR -UPETSC_DIR"
    ALLOC_NODES: "1"
    ALLOC_TIME: "30"
  extends: .src_build_on_toss4

toss4-llvm_19_1_3-tpl:
  variables:
    COMPILER: "llvm@19.1.3"
    SPEC: "--spec %${COMPILER}"
    ALLOC_NODES: "1"
    ALLOC_TIME: "45"
  extends: .tpl_build_on_toss4

toss4-gcc_13_3_1-tpl:
  variables:
    COMPILER: "gcc@13.3.1"
    SPEC: "--spec %${COMPILER}"
    ALLOC_NODES: "1"
    ALLOC_TIME: "45"
  extends: .tpl_build_on_toss4

toss4-llvm_19_1_3-examples:
  variables:
    COMPILER: "llvm@19.1.3"
    HOST_CONFIG: "dane-toss_4_x86_64_ib-${COMPILER}.cmake"
    EXTRA_CMAKE_OPTIONS: "-DCMAKE_BUILD_TYPE=Debug"
    ALLOC_NODES: "1"
    ALLOC_TIME: "30"
  extends: .examples_build_on_toss4

toss4-gcc_13_3_1-examples:
  variables:
    COMPILER: "gcc@13.3.1"
    HOST_CONFIG: "dane-toss_4_x86_64_ib-${COMPILER}.cmake"
    EXTRA_CMAKE_OPTIONS: "-DCMAKE_BUILD_TYPE=Debug"
    ALLOC_NODES: "1"
    ALLOC_TIME: "30"
  extends: .examples_build_on_toss4

toss4-llvm_19_1_3-benchmarks:
  variables:
    COMPILER: "llvm@19.1.3"
    HOST_CONFIG: "dane-toss_4_x86_64_ib-${COMPILER}.cmake"
    ALLOC_NODES: "1"
    ALLOC_TIME: "75"
  extends: .benchmarks_build_on_toss4

toss4-gcc_13_3_1-benchmarks:
  variables:
    COMPILER: "gcc@13.3.1"
    HOST_CONFIG: "dane-toss_4_x86_64_ib-${COMPILER}.cmake"
    ALLOC_NODES: "1"
    ALLOC_TIME: "75"
  extends: .benchmarks_build_on_toss4

# This comparison job simply runs Hatchet and compares against benchmarks generated across all configurations
toss4-comparison:
  variables:
    ALLOC_NODES: "1"
    ALLOC_TIME: "30"
  extends: .comparison_build_on_toss4
