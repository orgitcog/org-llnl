description:
    name: test_kosh_scaling_maestro
    description: A workflow to test Kosh scalability with parallel scaling calls.

env:
    variables:
        KOSH_STORE_DEFAULT: "mysql+mysqlconnector://cz-kosh-testkoshdb.apps.czapps.llnl.gov:30637/?read_default_file=${HOME}/.my.kosh.testdb.cnf"

    dependencies:
      paths:
        - name: KOSH_scaling_SCRIPT
          path: kosh_scaling.py

batch:

    # Dane
    type: slurm  # The name of the scheduler (can be local, slurm, lsf, or flux)
    bank: wbronze  # The account to charge computing time to
    queue: pdebug  # The scheduler queue/partition to submit jobs (study steps) to
    # queue: pbatch  # The scheduler queue/partition to submit jobs (study steps) to
    host: dane  # The name of the cluster to execute this study on

    # Lassen
    # type: lsf  # The name of the scheduler (can be local, slurm, lsf, or flux)
    # bank: wbronze  # The account to charge computing time to
    # queue: pdebug  # The scheduler queue/partition to submit jobs (study steps) to
    # host: lassen  # The name of the cluster to execute this study on

    # Tioga
    # type: flux  # The name of the scheduler (can be local, slurm, lsf, or flux)
    # queue: pdebug  # The scheduler queue/partition to submit jobs (study steps) to
    # host: tioga  # The name of the cluster to execute this study on

study:
    - name: kosh_scaling_clear
      description: Only clear store since running script in parallel will cause race conditions resulting in missing data.
      run:
        cmd: |
            python $(KOSH_scaling_SCRIPT) \
            --store $(KOSH_STORE) \
            --clear

    - name: kosh_scaling
      description: Run python Kosh script with parallel scaling calls.
      run:
        cmd: |
            $(LAUNCHER) python $(KOSH_scaling_SCRIPT) \
            --store $(KOSH_STORE) \
            --run-number $(RUN_NUMBER) \
            --ensembles $(ENSEMBLES) \
            --datasets $(DATASETS) \
            --lock-strategy OnlyRetry \
            --retries $(NUM_RETRY)
        nodes: 1
        procs: 1
        walltime: "00:30:00"
        depends: ["kosh_scaling_clear"]
