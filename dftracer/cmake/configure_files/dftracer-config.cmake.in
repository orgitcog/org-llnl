# This will create IMPORTED targets for dftracer. The executables will be
# the library will be dftracer::dftracer.

include("${CMAKE_CURRENT_LIST_DIR}/dftracer-config-version.cmake")

list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_LIST_DIR}")
list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_LIST_DIR}/modules")
list(APPEND CMAKE_MODULE_PATH "@EXTRA_CMAKE_MODULE_DIR@")

#include(GNUInstallDirs)
include(ExternalProject)
include(dftracer-utils)
include(CMakePackageConfigHelpers)

# Set library version from version file
set(DFTRACER_LIBRARY_VERSION "@DFTRACER_LIBRARY_VERSION@")
set(DFTRACER_VERSION "@DFTRACER_LIBRARY_VERSION@")  # For backward compatibility

# Record compiler information
set(DFTRACER_C_COMPILER "@CMAKE_C_COMPILER@")
set(DFTRACER_CXX_COMPILER "@CMAKE_CXX_COMPILER@")

set(DFTRACER_C_FLAGS "@CMAKE_C_FLAGS@")
set(DFTRACER_CXX_FLAGS "@CMAKE_CXX_FLAGS@")

set(DFTRACER_C_STANDARD "@CMAKE_C_STANDARD@")
set(DFTRACER_CXX_STANDARD "@CMAKE_CXX_STANDARD@")

set(CMAKE_C_STANDARD_REQUIRED TRUE)
set(CMAKE_CXX_STANDARD_REQUIRED TRUE)

# Record the various flags and switches accumlated in DFTRACER
set(DFTRACER_GNU_LINUX @DFTRACER_GNU_LINUX@)
set(DFTRACER_HAS_STD_FILESYSTEM @DFTRACER_HAS_STD_FILESYSTEM@)
set(DFTRACER_HAS_STD_FSTREAM_FD @DFTRACER_HAS_STD_FSTREAM_FD@)

# Setup dependencies


@PACKAGE_INIT@

# Compute paths based on whether we're in build or install tree
# Config file is at: <prefix>/lib/cmake/dftracer/dftracer-config.cmake
get_filename_component(_DFTRACER_CONFIG_DIR "${CMAKE_CURRENT_LIST_FILE}" PATH)
get_filename_component(_DFTRACER_PREFIX "${_DFTRACER_CONFIG_DIR}/../../.." ABSOLUTE)

# Check if we're in the build tree by looking for CMakeCache.txt
if(EXISTS "${_DFTRACER_PREFIX}/CMakeCache.txt")
  # Build tree - paths relative to build root
  set_and_check(DFTRACER_INCLUDE_DIR "${_DFTRACER_PREFIX}/include")
  set_and_check(DFTRACER_LIB_DIR "${_DFTRACER_PREFIX}/@DFTRACER_LIBDIR@")
else()
  # Install tree - use PACKAGE_PREFIX_DIR from @PACKAGE_INIT@
  set_and_check(DFTRACER_INCLUDE_DIR "@PACKAGE_DFTRACER_INSTALL_INCLUDE_DIR@")
  set_and_check(DFTRACER_LIB_DIR "@PACKAGE_DFTRACER_INSTALL_LIB_DIR@")
endif()

# Now actually import the DFTRACER target
set(_TMP_INCLUDE_DIRS "${DFTRACER_INCLUDE_DIR}")
foreach (_DIR ${_TMP_INCLUDE_DIRS})
  set_and_check(_INCLUDE_DIR "${_DIR}")
  list(APPEND DFTRACER_INCLUDE_DIRS "${_INCLUDE_DIR}")
endforeach (_DIR "${_TMP_INCLUDE_DIRS}")

set(_TMP_LIBRARY_DIRS "${DFTRACER_LIB_DIR}")
foreach (_DIR ${_TMP_LIBRARY_DIRS})
  set_and_check(_LIBRARY_DIR "${_DIR}")
  list(APPEND DFTRACER_LIBRARY_DIRS "${_LIBRARY_DIR}")
endforeach (_DIR ${_TMP_LIBRARY_DIRS})



# Always include targets file to ensure dftracer_core and others are defined
include(${CMAKE_CURRENT_LIST_DIR}/dftracer-targets.cmake)

# Recreate namespace ALIAS targets for consumers
if(TARGET dftracer_core AND NOT TARGET dftracer::dftracer_core)
  add_library(dftracer::dftracer_core ALIAS dftracer_core)
endif()
if(TARGET dftracer_core_dbg AND NOT TARGET dftracer::dftracer_core_dbg)
  add_library(dftracer::dftracer_core_dbg ALIAS dftracer_core_dbg)
endif()
if(TARGET dftracer_preload AND NOT TARGET dftracer::dftracer_preload)
  add_library(dftracer::dftracer_preload ALIAS dftracer_preload)
endif()
if(TARGET dftracer_preload_dbg AND NOT TARGET dftracer::dftracer_preload_dbg)
  add_library(dftracer::dftracer_preload_dbg ALIAS dftracer_preload_dbg)
endif()
if(TARGET dftracer_service AND NOT TARGET dftracer::dftracer_service)
  add_executable(dftracer::dftracer_service ALIAS dftracer_service)
endif()
# Backward compatibility: create dftracer alias if only dftracer_core exists
if (TARGET dftracer_core AND NOT TARGET dftracer)
  add_library(dftracer ALIAS dftracer_core)
endif()

# Find dependencies - these should already be linked transitively through dftracer targets
# but we verify theyre available for users who might need them directly

set(brahma_DIR "@brahma_DIR@")
set(gotcha_DIR "@gotcha_DIR@")
find_package(brahma QUIET)
if (NOT brahma_FOUND)
    message(FATAL_ERROR "[DFTRACER] brahma is required but not found. Please ensure brahma is installed.")
endif ()

set(yaml-cpp_DIR "@yaml-cpp_DIR@")
find_package(yaml-cpp QUIET)
if (NOT yaml-cpp_FOUND)
    message(FATAL_ERROR "[DFTRACER] yaml-cpp is required but not found. Please ensure yaml-cpp is installed.")
endif ()

set(DFTRACER_INCLUDE_MPI @DFTRACER_ENABLE_MPI@)
if (DFTRACER_INCLUDE_MPI)
  set(MPI_DIR "@MPI_DIR@")
  find_package(MPI COMPONENTS CXX QUIET)
  if (NOT MPI_FOUND)
    message(FATAL_ERROR "[DFTRACER] MPI is required but not found. Please ensure MPI is installed.")
  endif ()
endif()

# Backward compatibility: create dftracer alias if only dftracer_core exists
if (TARGET dftracer::dftracer_core AND NOT TARGET dftracer)
  add_library(dftracer ALIAS dftracer::dftracer_core)
endif()
set(DFTRACER_ENABLE_FTRACING @DFTRACER_ENABLE_FTRACING@)
if (DFTRACER_ENABLE_FTRACING)
set(DFTRACER_FUNCTION_FLAGS "-g" "-finstrument-functions" "-Wl,-E" "-fvisibility=default")
else()
set(DFTRACER_FUNCTION_FLAGS )
endif()
check_required_components(dftracer)

set(DFTRACER_LIBRARIES dftracer)
