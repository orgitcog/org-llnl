# Multi-platform Development Dockerfile for DFTracer
# Supports amd64 and arm64 architectures

ARG PYTHON_VERSION=3.10
FROM python:${PYTHON_VERSION}-slim as base

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    git \
    ninja-build \
    wget \
    curl \
    ca-certificates \
    pkg-config \
    libyaml-cpp-dev \
    hwloc \
    libhwloc-dev \
    mpich \
    libmpich-dev \
    python3-dev \
    python3-venv \
    gdb \
    vim \
    less \
    htop \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Set up working directory
WORKDIR /workspace/dftracer

# Install Python build dependencies first (cached layer)
RUN pip install --upgrade pip setuptools wheel && \
    pip install \
    pybind11 \
    ninja \
    cmake>=3.12 \
    setuptools>=64 \
    setuptools-scm>=8

# Install Python runtime dependencies
RUN pip install \
    pytest>=6.0 \
    numpy>=1.24.3 \
    pandas>=2.0.3

# Optional: Install dfanalyzer dependencies
RUN pip install \
    seaborn>=0.13.2 \
    bokeh>=2.4.2 \
    dask>=2023.5.0 \
    distributed \
    pyarrow>=12.0.1 \
    rich>=13.6.0 \
    python-intervals>=1.10.0.post1 \
    matplotlib>=3.7.3

# Keep apt cache for user to install packages later
# Copy dependency installation script
COPY dependency/install_dependency.sh /tmp/
COPY dependency/cpp.requirements.txt /tmp/

# Install C++ dependencies
RUN cd /tmp && \
    chmod +x install_dependency.sh && \
    ./install_dependency.sh /tmp/cpp.requirements.txt /usr/local && \
    rm -rf /tmp/*

# Update apt cache one final time and keep it (don't rm -rf)
RUN apt-get update

# Create a non-root user for development
ARG USERNAME=developer
ARG USER_UID=1000
ARG USER_GID=$USER_UID

RUN groupadd --gid $USER_GID $USERNAME \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME -s /bin/bash \
    && apt-get install -y sudo \
    && mkdir -p /etc/sudoers.d \
    && echo $USERNAME ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME

# Set the default user
USER $USERNAME

# Create Python virtual environment for the user
RUN python3 -m venv ~/.venv && \
    echo 'source ~/.venv/bin/activate' >> ~/.bashrc && \
    . ~/.venv/bin/activate && \
    pip install --upgrade pip setuptools wheel

# Set up shell for better development experience
RUN echo 'export PS1="\[\e[32m\]\u@dftracer-dev\[\e[m\]:\[\e[34m\]\w\[\e[m\]\$ "' >> ~/.bashrc && \
    echo '' >> ~/.bashrc && \
    echo '# Helpful aliases for development' >> ~/.bashrc && \
    echo 'alias ll="ls -alF"' >> ~/.bashrc && \
    echo 'alias apt-install="sudo apt-get install -y"' >> ~/.bashrc && \
    echo 'alias pip-install="pip install"' >> ~/.bashrc

WORKDIR /workspace/dftracer

# Default command
CMD ["/bin/bash"]
