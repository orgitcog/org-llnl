# Epic: AI Image Analysis

<epic>
  <id>ai-image-analysis</id>
  <name>AI Image Analysis</name>
  <status>todo</status>
  <initiative>session-editor</initiative>
  <depends_on>editor-core</depends_on>
  <estimated_effort>16 hours</estimated_effort>
</epic>

## Overview

AI Image Analysis enables automatic generation of descriptive notes for screenshots captured during browser sessions. By leveraging vision-capable AI models (Claude, GPT-4 Vision, or local models), the system analyzes each screenshot and creates detailed textual descriptions. These AI-generated notes allow LLMs to understand and answer questions about session content without needing to process images directly.

**Source PRD:** [PRD-ai-image-analysis.md](../../PRDs/PRD-ai-image-analysis.md)

## Target Users

| Role | Primary Use Cases |
|------|-------------------|
| Developers | Analyze sessions with AI coding assistants, generate bug reports with context |
| QA Engineers | Create comprehensive test documentation, share annotated sessions |
| Technical Writers | Generate documentation from recorded workflows |
| Support Teams | Analyze user-submitted session recordings with AI assistance |

## Problem Statement

Recorded browser sessions contain valuable visual information in screenshots, but this information is inaccessible to text-based AI systems:

- LLMs cannot directly interpret screenshot images when analyzing session data
- Users must manually describe each screenshot for AI tools to understand context
- Valuable visual context (UI state, error messages, form data) is lost in text-based analysis
- Manual annotation is time-consuming for sessions with many screenshots

## Goals

### Primary Goals

1. Enable **automatic analysis** of all screenshots in a session
2. Generate **LLM-friendly descriptions** that capture essential visual information
3. Support **multiple AI providers** (Claude, OpenAI, custom/local models)
4. Integrate seamlessly with the **Session Editor note system**

### Success Metrics

| Metric | Target |
|--------|--------|
| AI generates useful descriptions | 95%+ of screenshots |
| Average analysis time | < 5 seconds per image |
| Generated notes enable accurate LLM responses | About session content |
| Users can configure and start analysis | < 30 seconds |

## Features

### F1: Screenshot Catalog Export
- Generate `screenshots.md` during markdown export
- Include all screenshot paths with relative links
- Include context metadata (action type, timestamp, URL, viewport)
- Group screenshots by action with before/after distinction
- Quick reference table for all images

### F2: Batch AI Analysis
- "Analyze Images with AI" button in editor toolbar
- Progress modal shows current image being analyzed
- AI generates concise description for each screenshot (100-300 words)
- Notes created with `source: 'ai-generated'` metadata
- Option to skip already-annotated actions

### F3: AI Provider Configuration
- Provider selection: Claude, OpenAI, Custom endpoint
- API key input (securely stored)
- Model selection based on provider
- Concurrency setting (parallel requests)
- Custom prompt override option
- "Test Connection" validates credentials

### F4: Re-analyze Single Image
- "Re-analyze" button on AI-generated notes
- Can modify prompt before re-analysis
- Option to append to or replace existing note
- Single image analysis completes quickly

### F5: Full Analysis Mode
- Process all screenshots in session (no deduplication)
- Generate `image-analysis.md` with detailed descriptions
- Include session summary with key observations
- Show progress during analysis
- Support cancellation mid-analysis

## AI Note Content Guidelines

Notes generated by AI should include:

- **Page identification**: What page/screen is shown
- **Visible UI elements**: Buttons, forms, navigation, modals visible
- **Text content**: Key text, labels, error messages, headings
- **State indicators**: Loading states, validation errors, success messages
- **Context clues**: What action likely preceded/follows this screenshot
- **Data present**: Any visible data (usernames, prices, counts) - anonymized if sensitive

## Technical Requirements

### TR-1: Provider Abstraction

```typescript
interface AIProvider {
  name: string;
  analyzeImage(imageBlob: Blob, prompt: string, config: ProviderConfig): Promise<string>;
  validateCredentials(config: ProviderConfig): Promise<boolean>;
}
```

### TR-2: Rate Limiting

Default limits:
- Claude: 3 concurrent requests
- OpenAI: 5 concurrent requests
- Custom: Configurable (default 3)

### TR-3: Security

API keys shall be stored securely and never exposed in logs or exports:
- Store in localStorage with encryption or use browser's credential storage
- Never include in exported session data
- Clear on user request
- Mask in UI (password field)

### TR-4: Supported AI Models

| Provider | Models | Vision Support |
|----------|--------|----------------|
| Claude | claude-3-opus, claude-3-sonnet, claude-3-haiku | Yes (all) |
| OpenAI | gpt-4-vision-preview, gpt-4o, gpt-4o-mini | Yes (all) |
| Custom | Varies | Must support vision |

## Cost Estimates

| Session Size | Images | Estimated Cost | Time |
|--------------|--------|----------------|------|
| Small | 20-50 | ~$0.06-0.15 | 1-2 min |
| Medium | 50-100 | ~$0.15-0.30 | 2-4 min |
| Large | 100-200 | ~$0.30-0.60 | 4-8 min |
| Very Large | 200-500 | ~$0.60-1.50 | 8-20 min |

*Based on ~$0.003 per image with Claude Vision API*

## Dependencies

- Session Editor complete (epic-editor-core)
- External AI APIs (Claude, OpenAI, or custom endpoints)
- Browser APIs (Fetch for API calls, localStorage for config)

## Out of Scope (v1)

- Video frame analysis
- Multiple prompts per image
- Prompt templates library
- Cost estimation UI
- Offline/local-only mode (requires bundling large models)
- Speaker diarization

## Quality Attributes

### QA-1: Performance
- Individual image analysis < 5 seconds average
- Batch analysis of 50 images < 3 minutes
- UI remains responsive during analysis
- Progress updates at least every 2 seconds

### QA-2: Reliability
- API failures don't crash the application
- Failed analyses logged with error details
- Partial results saved if analysis cancelled
- Network timeouts handled gracefully

### QA-3: Security
- API keys never logged or exported
- Keys stored securely in browser
- No sensitive data sent to unintended endpoints

## Implementation Phases

| Phase | Focus | Estimate |
|-------|-------|----------|
| Phase 1 | Screenshot catalog markdown export | 3 hours |
| Phase 2 | AI provider abstraction and config UI | 4 hours |
| Phase 3 | Batch analysis with progress UI | 5 hours |
| Phase 4 | Full analysis mode and output generation | 4 hours |
| **Total** | | **16 hours** |
