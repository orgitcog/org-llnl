# --- This input defines 1D Pierce Diode Example:
# --- This test simulates a classic Pierce diode configuration:
# --- two parallel conducting plates separated by a distance
# --- d_plate = 8 cm and powered by a voltage difference
# --- extractor_voltage = -93 kV. The injected current density is
# --- chosen to match the space-charge-limited current predicted by
# --- the Childâ€“Langmuir law, that predicts the maximum current density
# --- that can flow between two parallel plates due to space-charge effects
# --- for a given voltage and gap length.

# constants
my_constants.ion_mass = 39*m_u # [kg] Assuming ion potassium
my_constants.kV = 1000
my_constants.cm = 0.01
my_constants.extractor_voltage  = -93.*kV
my_constants.d_plate = 8.*cm
my_constants.nz = 128
my_constants.dz = d_plate/nz
my_constants.vzfinal = sqrt(2.*abs(extractor_voltage)*q_e/ion_mass)
my_constants.dt = 0.4*(dz/vzfinal)
my_constants.ep0 = 8.8541878188e-12
# current density at Child-Langmuir limit
my_constants.J_CL = ( (4 / 9)* ep0 * sqrt(2 * abs(q_e) / ion_mass) * abs(extractor_voltage) ** (3 / 2) / d_plate**2 )
# algo
warpx.do_electrostatic = labframe
algo.particle_shape = 1

# amr
amr.n_cell = nz
amr.max_level = 0

# maxamx step
max_step = 5000

# timestep
warpx.const_dt = dt

# number of procs
warpx.numprocs = 2   # 2 MPI ranks

# geometry
geometry.dims = 1
geometry.prob_lo = 0.0
geometry.prob_hi = d_plate

# boundary
boundary.field_lo = pec
boundary.field_hi = pec
# set fixed potential at the plates (V difference)
boundary.potential_lo_z = 0.0      # cathode at x = 0 V
boundary.potential_hi_z = extractor_voltage  # anode at x = 1 kV
boundary.particle_lo = absorbing
boundary.particle_hi = absorbing

# ions
particles.species_names = ions
ions.charge = q_e
ions.mass = ion_mass
ions.do_continuous_injection = 1
ions.injection_style = "NFluxPerCell"
ions.num_particles_per_cell = 15
ions.surface_flux_pos = 0
ions.flux_normal_axis = z
ions.flux_direction = 1
ions.flux_profile = constant
ions.flux = J_CL/q_e # corresponds to Child-Langmuir limit
ions.momentum_distribution_type = constant

# diagnostics
diagnostics.diags_names = diag1
diag1.intervals = 5000
diag1.diag_type = Full
diag1.format=openpmd
diag1.fields_to_plot = Ez rho jz phi
