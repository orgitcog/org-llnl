# Copyright (c) 2017-2025, Lawrence Livermore National Security, LLC and
# other Axom Project Developers. See the top-level LICENSE file for details.
#
# SPDX-License-Identifier: (BSD-3-Clause)

####
# This is the shared configuration of jobs for matrix
.on_matrix:
  variables:
    SCHEDULER_PARAMETERS: "--partition=pci --exclusive=user --deadline=now+1hour -N1 -t ${ALLOC_TIME}"
  tags:
    - batch
    - matrix
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /_qnone/ || $ON_MATRIX == "OFF"' #run except if ...
      when: never
    - if: '$CI_JOB_NAME =~ /matrix_release/'
      when: always
    - when: on_success
  before_script:
    - module load cmake/3.26

####
# Template
.src_build_on_matrix:
  variables:
    ALLOC_TIME: "40"
  extends: [.src_build_script, .on_matrix, .src_workflow]
  needs: []

.full_build_on_matrix:
  variables:
    ALLOC_TIME: "70"
  extends: [.full_build_script, .on_matrix, .full_workflow]
  needs: []

####
# PR Build jobs
matrix-gcc_13_3_1_cuda-src:
  variables:
    COMPILER: "gcc@13.3.1_cuda"
    HOST_CONFIG: "matrix-toss_4_x86_64_ib-${COMPILER}.cmake"
  extends: .src_build_on_matrix
  # TODO: Fix unit tests failures
  allow_failure: true

####
# Full Build jobs
matrix-gcc_13_3_1_cuda-full:
  variables:
    COMPILER: "gcc-13"
    SPEC: "%+devtools+mfem+c2c+profiling+cuda cuda_arch=90 %${COMPILER}"
  extends: .full_build_on_matrix
