name: üêß HIP

on:
  push:
    branches:
      - "development"
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.ref }}-${{ github.head_ref }}-hip
  cancel-in-progress: true

jobs:

  check_changes:
    name: Analyze
    uses: ./.github/workflows/check_changes.yml

  build_hip_3d_sp:
    name: HIP 3D SP
    runs-on: ubuntu-24.04
    env:
      CXXFLAGS: "-Werror -Wno-deprecated-declarations -Wno-error=pass-failed"
      CMAKE_GENERATOR: Ninja
    needs: check_changes
    if: ${{ github.event.pull_request.draft == false && needs.check_changes.outputs.has_non_docs_changes == 'true' }}
    steps:
    - uses: actions/checkout@v4
    - name: install dependencies
      shell: bash
      run: .github/workflows/dependencies/hip.sh 6.3.2
    - name: CCache Cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-${{ github.workflow }}-${{ github.job }}-git-${{ github.sha }}
        restore-keys: |
             ccache-${{ github.workflow }}-${{ github.job }}-git-
    - name: build WarpX
      shell: bash
      run: |
        export CCACHE_COMPRESS=1
        export CCACHE_COMPRESSLEVEL=10
        export CCACHE_MAXSIZE=100M
        ccache -z

        source /etc/profile.d/rocm.sh
        hipcc --version
        which clang
        which clang++
        export CXX=$(which clang++)
        export CC=$(which clang)

        cmake -S . -B build_sp \
          -DCMAKE_VERBOSE_MAKEFILE=ON \
          -DAMReX_AMD_ARCH=gfx900     \
          -DWarpX_COMPUTE=HIP         \
          -DWarpX_EB=ON               \
          -DWarpX_PYTHON=ON           \
          -DWarpX_MPI=ON              \
          -DWarpX_OPENPMD=ON          \
          -DWarpX_PRECISION=SINGLE    \
          -DWarpX_FFT=ON
        cmake --build build_sp -j 4

        export WARPX_MPI=OFF
        export PYWARPX_LIB_DIR=$PWD/build_sp/lib/site-packages/pywarpx/
        python3 -m pip wheel .
        python3 -m pip install *.whl

        ccache -s
        du -hs ~/.cache/ccache

  build_hip_2d_dp:
    name: HIP 2D DP
    runs-on: ubuntu-24.04
    env:
      CXXFLAGS: "-Werror -Wno-deprecated-declarations -Wno-error=pass-failed"
      CMAKE_GENERATOR: Ninja
    needs: check_changes
    if: ${{ github.event.pull_request.draft == false && needs.check_changes.outputs.has_non_docs_changes == 'true' }}
    steps:
    - uses: actions/checkout@v4
    - name: install dependencies
      shell: bash
      run: .github/workflows/dependencies/hip.sh 6.3.2
    - name: CCache Cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-${{ github.workflow }}-${{ github.job }}-git-${{ github.sha }}
        restore-keys: |
             ccache-${{ github.workflow }}-${{ github.job }}-git-
    - name: build WarpX
      shell: bash
      run: |
        export CCACHE_COMPRESS=1
        export CCACHE_COMPRESSLEVEL=10
        export CCACHE_MAXSIZE=100M
        ccache -z

        source /etc/profile.d/rocm.sh
        hipcc --version
        which clang
        which clang++
        export CXX=$(which clang++)
        export CC=$(which clang)

        cmake -S . -B build_2d \
          -DCMAKE_VERBOSE_MAKEFILE=ON \
          -DAMReX_AMD_ARCH=gfx900     \
          -DWarpX_DIMS=2              \
          -DWarpX_COMPUTE=HIP         \
          -DWarpX_EB=ON               \
          -DWarpX_PYTHON=ON           \
          -DWarpX_MPI=ON              \
          -DWarpX_OPENPMD=ON          \
          -DWarpX_PRECISION=DOUBLE    \
          -DWarpX_FFT=ON
        cmake --build build_2d -j 4

        export WARPX_MPI=OFF
        export PYWARPX_LIB_DIR=$PWD/build_2d/lib/site-packages/pywarpx/
        python3 -m pip wheel .
        python3 -m pip install *.whl

        ccache -s
        du -hs ~/.cache/ccache
