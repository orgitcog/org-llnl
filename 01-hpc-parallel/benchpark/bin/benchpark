#!/usr/bin/env python3
#
# Copyright 2023 Lawrence Livermore National Security, LLC and other
# Benchpark Project Developers. See the top-level COPYRIGHT file for details.
#
# SPDX-License-Identifier: Apache-2.0

import os
import pathlib
import subprocess
import sys
import uuid


def main():
    if sys.version_info[0] < 3 or sys.version_info[1] < 8:
        raise Exception("\n\nERR: Must be using Python 3.8 or later!\n")
    basedir = pathlib.Path(__file__).resolve().parents[1]
    main_py = basedir / "lib" / "main.py"

    if os.environ.get("BENCHPARK_RUN_COVERAGE"):
        # Create a unique coverage data file name
        coverage_dir = (
            basedir / f"coverage-data-{os.environ.get('BENCHPARK_RUN_COVERAGE')}"
        )
        coverage_dir.mkdir(exist_ok=True, parents=True)
        unique_id = uuid.uuid4().hex
        coverage_file = coverage_dir / f".coverage.{unique_id}"
        # Run the code with coverage, writing to the unique file
        subprocess.run(
            [
                sys.executable,
                "-m",
                "coverage",
                "run",
                f"--data-file={coverage_file}",
                "--source=lib",
                main_py,
            ]
            + sys.argv[1:],
            check=True,
        )
    else:
        subprocess.run([sys.executable, main_py] + sys.argv[1:], check=True)


if __name__ == "__main__":
    main()
