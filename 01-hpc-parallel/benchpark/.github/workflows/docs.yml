name: Build & Deploy docs site to GitHub Pages
on:
  workflow_call:
jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: .github/workflows/requirements/docs.txt
      - name: Setup GitHub Pages
        id: pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b
      - name: Install Sphinx and Theme via Pip
        run: |
          pip install -r .github/workflows/requirements/docs.txt
          # create a dummy workspace to get a working ramble
          bin/benchpark system init --dest=generic-x86 generic-x86
          bin/benchpark experiment init --dest=saxpy generic-x86 saxpy
          bin/benchpark setup generic-x86/saxpy /tmp/workspace
          # this is gross and we should better setup ramble for people or make it a Spack package
          pip install -r /tmp/workspace/ramble/requirements.txt
      - name: Build with sphinx
        run: |
          cd docs
          make html WORKSPACE_PATH=/tmp/workspace
      - name: Check for Typos using Codespell
        run: |
          codespell --ignore-words=.codespellignore
      - name: Upload artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b
        if: github.ref == 'refs/heads/develop'
        with:
          path: ./docs/_build/html
  deploy:
    needs: build
    if: github.ref == 'refs/heads/develop'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-24.04
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e
