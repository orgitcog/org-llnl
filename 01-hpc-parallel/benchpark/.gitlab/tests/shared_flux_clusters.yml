include:
  - local: .gitlab/utils/status.yml
  - local: .gitlab/utils/machine_checks.yml
  - local: .gitlab/utils/rules.yml
workflow:
  auto_cancel:
    on_new_commit: conservative
#############################
# Resource Allocation Section
#############################
.allocate_resources_flux:
  extends: .on_host_template
  stage: allocate-resources
  script:
    - set -x
    - flux --parent alloc ${SHARED_ALLOC} --job-name=${ALLOC_NAME}${GPUMODE} --bg
  after_script:
    - |
      if [[ "$CI_JOB_STATUS" == "canceled" ]]; then
        . .gitlab/utils/cancel-flux.sh
      fi
allocate_resources_tuolumne:
  extends: .allocate_resources_flux
  parallel:
    matrix:
      - HOST: tuolumne
        SHARED_ALLOC: $TUOLUMNE_SHARED_ALLOC
        GPUMODE: [SPX, TPX, CPX]
  tags: [shell, tuolumne]
  needs: [tuolumne-up-check]
allocate_resources_tioga:
  extends: .allocate_resources_flux
  variables:
    HOST: tioga
    SHARED_ALLOC: $TIOGA_SHARED_ALLOC
  tags: [shell, tioga]
  needs: [tioga-up-check]
##########################
# Resource Release Section
##########################
.release_resources_flux:
  extends: .on_host_template
  stage: release-resources
  # Do not cleanup dir yet
  script: [. .gitlab/utils/cancel-flux.sh --no-clean]
release_resources_flux_tuolumne:
  extends: .release_resources_flux
  needs: [allocate_resources_tuolumne, run_tests_flux_tuolumne]
  parallel:
    matrix:
      - HOST: tuolumne
        GPUMODE: [SPX, TPX, CPX]
  tags: [shell, tuolumne]
release_resources_flux_tioga:
  extends: .release_resources_flux
  needs: [allocate_resources_tioga, run_tests_flux_tioga]
  variables:
    HOST: tioga
  tags: [shell, tioga]
##################
# Test Run Section
##################
.run_tests_flux:
  stage: test
  extends: .on_host_template
  before_script:
    - !reference [.report_status, before_script]
  script:
    - |
      ALLOC_ID=$(flux jobs --name="${ALLOC_NAME}${GPUMODE}" -n -o "{id}")
      echo -e "[Information]: Shared allocation ID = ${ALLOC_ID}"
      PROXY="$( [[ -n "${ALLOC_ID}" ]] && echo "flux proxy ${ALLOC_ID}" || echo "" )"
    - ${PROXY} flux watch $( ${PROXY} flux batch -o output.stdout.type=kvs ${FLUX_ARGS}
      .gitlab/utils/run-experiment.sh )
  after_script:
    - !reference [.report_status, after_script]
    - |
      if [[ "$CI_JOB_STATUS" == "canceled" ]]; then
        . .gitlab/utils/cancel-flux.sh
      fi
run_tests_flux_tuolumne:
  extends: .run_tests_flux
  tags: [shell, tuolumne]
  needs: [allocate_resources_tuolumne]
  parallel:
    matrix:
      - HOST: tuolumne
        ARCHCONFIG: llnl-elcapitan
        BENCHMARK:
          - amg2023
          - kripke
          - laghos
          - lammps
          - raja-perf
          - sparta-snl
        VARIANT: [+rocm]
        GPUMODE: SPX
      # Test TPX, CPX
      - HOST: tuolumne
        ARCHCONFIG: llnl-elcapitan
        BENCHMARK: [amg2023, kripke, laghos]
        VARIANT: [+rocm+strong scaling-iterations=2]
        SYSTEM_ARGS: [gpumode=TPX]
        GPUMODE: TPX
      - HOST: tuolumne
        ARCHCONFIG: llnl-elcapitan
        BENCHMARK: [kripke, laghos]
        VARIANT: [+rocm+strong scaling-iterations=2]
        SYSTEM_ARGS: [gpumode=CPX]
        GPUMODE: CPX
      # Test openmp on tuolumne
      - HOST: tuolumne
        ARCHCONFIG: llnl-elcapitan
        BENCHMARK: [kripke]
        VARIANT: [+openmp]
        GPUMODE: SPX
      # Test kripke+rocm+single_memory on tuolumne
      - HOST: tuolumne
        ARCHCONFIG: llnl-elcapitan
        BENCHMARK: [kripke]
        VARIANT: [+rocm+single_memory]
        GPUMODE: SPX
      # Caliper profile.hip
      - HOST: tuolumne
        ARCHCONFIG: llnl-elcapitan
        BENCHMARK: [kripke]
        VARIANT: ['+rocm caliper=mpi,time,rocm']
        GPUMODE: SPX
run_tests_flux_tioga:
  extends: .run_tests_flux
  tags: [shell, tioga]
  needs: [allocate_resources_tioga]
  parallel:
    matrix:
      - HOST: tioga
        ARCHCONFIG: llnl-elcapitan
        BENCHMARK: [amg2023, kripke, laghos, raja-perf]
        VARIANT: [+rocm]
