include:
  - local: .gitlab/utils/status.yml
  - local: .gitlab/utils/rules.yml
.test_clusters_nightly: &test_clusters_nightly
  variables:
    DASHBOARD_NAME: Nightly [benchpark-develop]
    DANE_PARAMS: -N 1 -t 01:00:00 --exclusive --reservation=ci
    MATRIX_PARAMS: -N 1 -t 01:00:00 --exclusive
    ELCAP_PARAMS: -N 1 -t 60m --queue=pci --exclusive
  parallel:
    matrix:
      # MPI-only tests
      - HOST: dane
        ARCHCONFIG: llnl-cluster
        SCHEDULER_PARAMETERS: $DANE_PARAMS
        BENCHMARK:
          - ad
          - amg2023
          - gpcnet
          - hpcg
          - hpl
          - kripke
          - laghos
          - lammps
          - md-test
          - osu-micro-benchmarks
          - phloem
          - raja-perf
          - remhos
          - smb
          - sparta-snl
          - stream
      # salmon-tddft doesn't build with oneAPI, use gcc
      - HOST: dane
        ARCHCONFIG: llnl-cluster
        SCHEDULER_PARAMETERS: $DANE_PARAMS
        SYSTEM_ARGS: [compiler=gcc]
        BENCHMARK: salmon-tddft
      # IOR needs a mount_point
      - HOST: dane
        ARCHCONFIG: llnl-cluster
        SCHEDULER_PARAMETERS: $DANE_PARAMS
        SYSTEM_ARGS: [mount_point="/p/lustre1"]
        BENCHMARK: ior
      # +rocm tests
      - HOST: [tuolumne]
        ARCHCONFIG: llnl-elcapitan
        SCHEDULER_PARAMETERS: $ELCAP_PARAMS
        BENCHMARK:
          - amg2023
          - babelstream
          - branson
          - kripke
          - laghos
          - lammps
          - osu-micro-benchmarks
          - raja-perf
          - remhos
          - sparta-snl
        VARIANT: [+rocm]
      # +openmp tests
      - HOST: dane
        ARCHCONFIG: llnl-cluster
        SCHEDULER_PARAMETERS: $DANE_PARAMS
        BENCHMARK:
          - amg2023
          - babelstream
          - branson
          - genesis
          - hpcg
          - hpl
          - kripke
          - lammps
          - raja-perf
        VARIANT: [+openmp]
      # qws/salmon-tddft don't build with oneAPI, use gcc
      - HOST: dane
        ARCHCONFIG: llnl-cluster
        SCHEDULER_PARAMETERS: $DANE_PARAMS
        SYSTEM_ARGS: [compiler=gcc]
        BENCHMARK: [qws, salmon-tddft]
      # +cuda tests
      - HOST: matrix
        ARCHCONFIG: llnl-matrix
        SCHEDULER_PARAMETERS: $MATRIX_PARAMS
        BENCHMARK:
          - amg2023
          - babelstream
          - branson
          - gromacs
          - kripke
          - laghos
          - lammps
          - osu-micro-benchmarks
          - raja-perf
          - remhos
          - saxpy
        VARIANT: [+cuda]
      - HOST: matrix
        ARCHCONFIG: llnl-matrix
        SCHEDULER_PARAMETERS: $MATRIX_PARAMS
        BENCHMARK: [sparta-snl]
        VARIANT: [+cuda~gpu-aware-mpi]
      #############
      # Other tests
      #############
      # Test TPX, CPX modes on tuo
      - HOST: tuolumne
        ARCHCONFIG: llnl-elcapitan
        SCHEDULER_PARAMETERS: $ELCAP_PARAMS --setattr=gpumode=${GPUMODE} --conf=resource.rediscover=true
        BENCHMARK: [amg2023, kripke, laghos, raja-perf]
        VARIANT: [+rocm]
        GPUMODE: [TPX, CPX]
        SYSTEM_ARGS: [gpumode=$GPUMODE]
      # Test benchmark@develop
      - HOST: dane
        ARCHCONFIG: llnl-cluster
        SCHEDULER_PARAMETERS: $DANE_PARAMS
        BENCHMARK: [amg2023, kripke, lammps, raja-perf, remhos, stream]
        BENCHMARK_VERSION: develop
      # Lammps workload=pace
      - HOST: dane
        ARCHCONFIG: llnl-cluster
        SCHEDULER_PARAMETERS: $DANE_PARAMS
        BENCHMARK: [lammps]
        VARIANT: [workload=pace]
      - HOST: matrix
        ARCHCONFIG: llnl-matrix
        SCHEDULER_PARAMETERS: $MATRIX_PARAMS
        BENCHMARK: [lammps]
        VARIANT: [+cuda workload=pace]
      - HOST: tuolumne
        ARCHCONFIG: llnl-elcapitan
        SCHEDULER_PARAMETERS: $ELCAP_PARAMS
        BENCHMARK: [lammps]
        VARIANT: [+rocm workload=pace]
        GPUMODE: SPX
      # AMG2023 workload=problem2
      - HOST: dane
        ARCHCONFIG: llnl-cluster
        SCHEDULER_PARAMETERS: $DANE_PARAMS
        BENCHMARK: [amg2023]
        VARIANT: [workload=problem2]
      - HOST: matrix
        ARCHCONFIG: llnl-matrix
        SCHEDULER_PARAMETERS: $MATRIX_PARAMS
        BENCHMARK: [amg2023]
        VARIANT: [+cuda workload=problem2]
      - HOST: tuolumne
        ARCHCONFIG: llnl-elcapitan
        SCHEDULER_PARAMETERS: $ELCAP_PARAMS
        BENCHMARK: [amg2023]
        VARIANT: [+rocm workload=problem2]
        GPUMODE: SPX
      # Rabbit test
      - HOST: tuolumne
        ARCHCONFIG: llnl-elcapitan
        SCHEDULER_PARAMETERS: $ELCAP_PARAMS -S dw=lustre_small
        BENCHMARK: [ior]
        SYSTEM_ARGS: [mount_point=rabbits_lustre_small]
nightly_test_run:
  extends: .nightly_rules
  resource_group: $HOST
  stage: test
  tags: [$HOST, batch]
  <<: *test_clusters_nightly
  before_script:
    - !reference [.report_status, before_script]
  script: [./.gitlab/utils/run-experiment.sh]
  after_script:
    - !reference [.report_status, after_script]
