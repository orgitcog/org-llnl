FROM centos:centos8

# Update CentOS 8 repositories (CentOS 8 is EOL, use vault)
RUN cd /etc/yum.repos.d/ && \
    sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-* && \
    sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*

# Update system
RUN yum update -y

# Install base development tools and dependencies
RUN yum install -y \
    gcc \
    clang \
    llvm \
    elfutils-libelf-devel \
    kernel-devel \
    kernel-headers \
    make \
    iproute \
    iputils \
    git \
    vim-enhanced \
    which \
    python3-pip \
    cmake \
    llvm-devel \
    clang-devel \
    gcc-toolset-11 \
    jq \
    time

# Install Development Tools group
RUN dnf group install -y "Development Tools"

# Set up working directory
WORKDIR /opt

# Build and install bpftool and libbpf
RUN . /opt/rh/gcc-toolset-11/enable && \
    git clone --recurse-submodules https://github.com/libbpf/bpftool.git && \
    cd bpftool && \
    git checkout tags/v7.5.0 && \
    cd libbpf && \
    git checkout tags/v1.5.0 && \
    cd /opt/bpftool/libbpf/src && \
    make -j && \
    make install && \
    cd /opt/bpftool/src && \
    make -j && \
    make install

# Build and install yaml-cpp
RUN . /opt/rh/gcc-toolset-11/enable && \
    git clone https://github.com/jbeder/yaml-cpp.git && \
    cd yaml-cpp && \
    git checkout tags/yaml-cpp-0.7.0 && \
    mkdir build && \
    cd build && \
    cmake -DYAML_BUILD_SHARED_LIBS=ON -DYAML_CPP_BUILD_TESTS=OFF .. && \
    make -j && \
    make install

# Build and install json-c
RUN . /opt/rh/gcc-toolset-11/enable && \
    git clone https://github.com/json-c/json-c.git && \
    cd json-c && \
    git checkout tags/json-c-0.15-20200726 && \
    mkdir build && \
    cd build && \
    cmake .. && \
    make -j && \
    make install

# Update library path
RUN echo "/usr/local/lib64" > /etc/ld.so.conf.d/local.conf && \
    echo "/usr/local/lib" >> /etc/ld.so.conf.d/local.conf && \
    ldconfig

# Create datacrumbs directory
WORKDIR /opt/datacrumbs

# Set environment variables
ENV PATH="/opt/rh/gcc-toolset-11/root/usr/bin:${PATH}"
ENV LD_LIBRARY_PATH="/opt/rh/gcc-toolset-11/root/usr/lib64:/usr/local/lib64:/usr/local/lib:${LD_LIBRARY_PATH}"

# Create entrypoint script
RUN echo '#!/bin/bash' > /entrypoint.sh && \
    echo '. /opt/rh/gcc-toolset-11/enable' >> /entrypoint.sh && \
    echo 'exec "$@"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Set the entrypoint
ENTRYPOINT ["/entrypoint.sh"]

# By default, run bash
CMD ["/bin/bash"]

# Add labels for better container management
LABEL maintainer="DataCrumbs Team"
LABEL description="DataCrumbs eBPF-based data provenance tracking system"
LABEL version="1.0"
