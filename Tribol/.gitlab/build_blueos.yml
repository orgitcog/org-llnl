##############################################################################
# Copyright (c) 2017-2025, Lawrence Livermore National Security, LLC and
# other Tribol Project Developers. See the top-level COPYRIGHT file for details.
#
# SPDX-License-Identifier: (MIT)
##############################################################################

####
# This is the share configuration of jobs for blueos
.on_blueos:
  variables:
    SCHEDULER_PARAMETERS: -nnodes ${ALLOC_NODES} -W ${ALLOC_TIME} -q pci -G ${ALLOC_BANK}
  tags:
    - batch
    - lassen
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /_lnone/ || $ON_BLUEOS == "OFF"' #run except if ...
      when: never
    - when: on_success
  before_script:
    # python3.8 is needed on blueos to avoid trampling on the x86 clingo wheel
    - module load python/3.8
    # CMake >= 3.17 is needed for FindCUDAToolkit with caliper
    # We could also extract the CMake executable location from the hostconfig in common_build_functions
    # like we do in config-build
    - module load cmake/3.23.1
    # Workaround for multiple before_scripts - see https://gitlab.com/gitlab-org/gitlab-runner/-/issues/2301
    # See also https://github.com/LLNL/smith/pull/417#discussion_r631194968
    - if [[ $CUDA_BUILD == "ON" ]]; then module load cuda/11.8.0; fi

####
# Load required CUDA module
.with_cuda:
  variables:
    CUDA_BUILD: "ON"

####
# Template
.src_build_on_blueos:
  extends: [.src_build_script, .on_blueos]

####
# Build jobs
blueos-clang_14_0_5-src:
  variables:
    COMPILER: "clang@14.0.5"
    HOST_CONFIG: "lassen-blueos_3_ppc64le_ib_p9-${COMPILER}_cuda.cmake"
    ALLOC_NODES: "1"
    ALLOC_TIME: "20"
  extends: [.src_build_on_blueos, .with_cuda]
