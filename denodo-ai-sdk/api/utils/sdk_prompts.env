VQL_RULES = "
1. Table names must use the format \"<database_name>\".\"<table_name>\". In the schema, they appear this way. For instance,
if the database is 'organization' and the table is 'employees', reference it as: \"organization\".\"employees\".
Column names must also be wrapped in double quotes. Generating SELECT * FROM employees will fail.
Generating SELECT \"CustomerID\" FROM \"お客様\".\"Clients\", will.

In the case of a JOIN operation, you must also include the table alias (if it exists) wrapped in quotes, like so:

<vql>
    SELECT 
        \"c\".\"CustomerID\", 
        \"o\".\"OrderID\", 
    FROM 
        \"お客様\".\"Clients\" c
    JOIN 
        \"お客様\".\"Orders\" o
    ON 
        \"c\".\"CustomerID\" = \"o\".\"CustomerID\";
</vql>

2. CAST is supported in VQL with these types: 

BOOL, CHAR, DECIMAL, FLOAT, FLOAT4, FLOAT8, INT2, INT4, INT8, INTEGER, REAL, TEXT, and VARCHAR.

Valid example using INT2:

SELECT CAST(\"quantity\" AS INT2) FROM \"organization\".\"hardware_bv\"

Only use CAST if necessary, as columns typically have the desired data type.

3. In VQL, use double quotes, not single quotes, for column aliases. For example:

    SELECT SUM(revenue) AS \"Total Revenue\"
    FROM \"organization\".\"products\"

Additionally, VQL protected words cannot be used as aliases.
The protected words in VQL are BASE, DF, NOS, OBL, and WS. Using one will cause an error, e.g., SELECT * FROM \"example_db\".\"example_table\" AS WS.

4. VQL String Literals and Functions.

- Use single quotes: WHERE name = 'Joseph'
- Escape single quotes by doubling them: 'D''angelo' matches \"D'angelo\"

- SUBSTR(string, start index, length?). Index starts at 1. The length sets the number of characters to return and includes the index character. If length is omitted, the substring returns everything until the end of the string.
   Example: SUBSTR('Artificial', 2, 5) → 'rtifi'
   Example: SUBSTR('Artificial', 2) → 'rtificial'

- CONCAT(str1, str2, ..., strN). Joins strings together. Requires 2+ parameters.
    Example: CONCAT(GETYEAR(date), '-', GETMONTH(date), '-', GETDAY(date))

- LEN(string). Returns string length

- POSITION(needle IN haystack). Finds starting position of a substring.
    Example: POSITION('no' IN 'Denodo') returns 3

5. In VQL, LIMIT and FETCH can only be used in the main query and not in subqueries. CTE is also considered a subquery.

Example of valid LIMIT in main query:

    SELECT * 
    FROM \"bank\".\"customers\"
    LIMIT 3;

Example of invalid LIMIT in subquery:

    WHERE \"c\".\"customer_id\" = (
        SELECT \"customer_id\"
        FROM \"bank\".\"loans\"
        GROUP BY \"customer_id\"
        ORDER BY SUM(loan_amount) DESC
        LIMIT 1
    );

Example of invalid LIMIT in CTE:

    WITH \"TotalEQ\" AS (
        SELECT \"customer_id\"
        FROM \"bank\".\"loans\"
        GROUP BY \"customer_id\"
        ORDER BY SUM(loan_amount) DESC
        LIMIT 1
    );

6. HAVING clauses are valid in VQL, but subqueries are not allowed in a HAVING clause. A CTE is also considered a subquery.

Valid example of a HAVING clause in VQL:

    SELECT \"department\", AVG(salary) AS \"avg_salary\"
    FROM \"organization\".\"employees\"
    GROUP BY \"department\"
    HAVING AVG(salary) > 30000;

Example of invalid HAVING clause (uses subquery SELECT department...):

    SELECT \"department\", AVG(salary) AS \"avg_salary\"
    FROM \"organization\".\"employees\"
    GROUP BY \"department\"
    HAVING \"department\" IN (SELECT \"department\" FROM \"organization\".\"managers\" WHERE \"status\" = 'senior');

Example of invalid HAVING clause (uses a CTE):

    WITH salary_threshold AS (
        SELECT 30000 AS threshold
    )
    SELECT \"department\", AVG(salary) AS \"avg_salary\"
    FROM \"organization\".\"employees\", salary_threshold
    GROUP BY \"department\"
    HAVING AVG(salary) > threshold;

7. In VQL, NULLS LAST is invalid in ORDER BY.

8. In VQL, you cannot use aggregate functions directly in the ORDER BY clause if they are not projected in the SELECT list or projected but inside another function. To avoid this:

- Create the alias name for the projected field
- Use alias name in the ORDER BY clause.

Valid example of using an aggregate function in an ORDER BY clause:

    SELECT \"user\", ROUND(SUM(\"amount\") / 100000000, 2) AS \"total_amount\"
    FROM \"bank\".\"customer\"
    GROUP BY \"user\"
    ORDER BY \"total_amount\"

Invalid example of using an aggregate function in an ORDER BY clause:

    SELECT \"user\", ROUND(SUM(\"amount\") / 100000000, 2) AS \"total_amount\"
    FROM \"bank\".\"customer\"
    GROUP BY \"user\"
    ORDER BY SUM(\"amount\")

{EXTRA_RESTRICTIONS}
"

DATES_VQL = "
VQL Date Functions

Convert Text to Date
- Function: TO_TIMESTAMPTZ(pattern, text). The pattern follows date and time Java patterns.
- Purpose: Convert TEXT to DATE for date comparisons in VQL.
- WARNING: TO_DATE is deprecated, use TO_TIMESTAMPTZ instead.

Date Filtering Examples

1. Date Column (TYPE: DATE)
   SELECT COUNT(\"p\".\"payment_id\") AS \"count_payments\"
   FROM \"bank\".\"payments\" AS p
   WHERE \"p\".\"payment_date\" BETWEEN 
         TO_TIMESTAMPTZ('yyyy-MM-dd', '2023-01-01') AND 
         TO_TIMESTAMPTZ('yyyy-MM-dd', '2023-12-31');

2. Text Column (TYPE: TEXT)
   SELECT COUNT(\"p\".\"payment_id\") AS \"count_payments\"
   FROM \"bank\".\"payments\" AS p
   WHERE TO_TIMESTAMPTZ('yyyy-MM-dd', \"p\".\"payment_date\") BETWEEN 
         TO_TIMESTAMPTZ('yyyy-MM-dd', '2023-01-01') AND 
         TO_TIMESTAMPTZ('yyyy-MM-dd', '2023-12-31');

3. Filter from Now to 3 Months Ago (TYPE: DATE)
   SELECT COUNT(\"p\".\"payment_id\") AS \"count_payments\"
   FROM \"bank\".\"payments\" AS p
   WHERE \"p\".\"payment_date\" BETWEEN ADDMONTH(NOW(), -3) AND NOW();

Date Modification Functions
- Add/Subtract:
  - ADDDAY(date, days)
  - ADDHOUR(date, hours)
  - ADDMINUTE(date, minutes)
  - ADDSECOND(date, seconds)
  - ADDWEEK(date, weeks)
  - ADDYEAR(date, years)
  - ADDMONTH(date, months)

Extract Information from Timestamp
- Functions:
  - GETDAY(date)
  - GETDAYOFWEEK(date)
  - GETDAYOFYEAR(date)
  - GETDAYSBETWEEN(date1, date2)
  - GETHOUR(date)
  - GETMILLISECOND(date)
  - GETMINUTE(date)
  - GETMONTH(date)
  - GETMONTHSBETWEEN(date1, date2)
  - GETQUARTER(date)
  - GETSECOND(date)
  - GETWEEK(date)
  - GETYEAR(date)

Examples of Extracting Information

1. Get Month and Sum Revenue
   SELECT GETMONTH(date) AS \"month\", SUM(revenue)
   FROM \"organization\".\"sales_bv\"
   GROUP BY \"month\";

2. Calculate Age in Years
   SELECT \"student_id\", \"student_name\", 
          (GETYEAR(NOW()) - GETYEAR(\"student_birthday\")) AS \"age\"
   FROM \"school\".\"students\";

Additional Notes
- Use NOW() to get the current timestamp.
"

ARITHMETIC_VQL = "
Arithmetic in VQL:

- Use MULT(x, y) for multiplication.
- Use DIV(dividend, divisor) for division.
- Use STDEV() to calculate the standard deviation over a set.

Types matter in VQL. Operations between INTEGERs yield INTEGER results, losing decimals. CAST to FLOAT to preserve decimals, especially for percentages.

Example:
SELECT DIV(4, 100) returns 0.
Use SELECT DIV(CAST(4 AS FLOAT), CAST(100 AS FLOAT)) to get 0.04.

In VQL, you must avoid division by zero by adding explict conditions to check for values different from 0.

Invalid examples of dividing by zero:

    Example 1: Simple division
        SELECT \"sales\".\"revenue\" / \"sales\".\"units_sold\" AS \"price_per_unit\"
        FROM \"company\".\"sales\"
        
    Example 2: Percentage calculation
        SELECT \"students\".\"passed_exams\" / \"students\".\"total_exams\" * 100 AS \"pass_rate\"
        FROM \"school\".\"students\"

    Example 3: Using CASE but missing zero check
        CASE 
        WHEN \"orders\".\"total_items\" IS NOT NULL THEN \"orders\".\"total_cost\" / \"orders\".\"total_items\"
        ELSE NULL 
        END

All above examples will throw an error if the divisor (units_sold, total_exams, total_items) is zero.

Valid examples with proper zero checks:

    Example 1: Simple division with zero check
        SELECT 
            CASE 
            WHEN \"sales\".\"units_sold\" != 0 THEN \"sales\".\"revenue\" / \"sales\".\"units_sold\"
            ELSE NULL 
            END AS \"price_per_unit\"
        FROM \"company\".\"sales\"

    Example 2: Percentage calculation with zero check
        SELECT 
            CASE 
            WHEN \"students\".\"total_exams\" != 0 THEN \"students\".\"passed_exams\" / \"students\".\"total_exams\" * 100
            ELSE NULL 
            END AS \"pass_rate\"
        FROM \"school\".\"students\"

    Example 3: Complete CASE with both NULL and zero checks
        CASE 
        WHEN \"orders\".\"total_items\" IS NOT NULL AND \"orders\".\"total_items\" != 0 THEN \"orders\".\"total_cost\" / \"orders\".\"total_items\"
        ELSE NULL 
        END 
"

QUERY_TO_VQL = "You are an expert VQL query generator.
Here are the rules you must follow when generating VQL queries:

{vql_restrictions}

Follow the instructions to generate a valid VQL query to answer the user's question.

 - Use exact table/database names as provided in the schema, do not use system tables
 - If schema lacks the needed tables/columns, explain so in <thoughts></thoughts>
 - If the provided <schema> is empty or insufficient to generate a valid VQL query, return <vql>None</vql>.
- Use the samples provided for each table (if any) to understand the data.
- Make sure to understand the granularity of the schema in order to generate a precise VQL query
- Do not include backticks (```, ```vql) or markdown in your response.
- You can only generate a SINGLE VQL query in between <vql></vql> tags to answer the user's question.
{custom_instructions}

Today's date is:
<date>
{date}
</date>

Here is the user's question: 
<question>
{query}
</question>

Here is the relevant schema. Pay special attention to column types and sample data (if available) to understand the schema:
<schema>
{schema}
</schema>

To generate a valid VQL query that answers the user's question, follow this process:
1. Break down the query generation process in between <thoughts></thoughts> tags:
    - What the expected output of the VQL query would be (Single value, multiple rows, multiple columns...)
    - What the granularity of the relevant tables for this question is
2. If using filters or JOIN, write down your suggested filter/JOIN conditions between <conditions></conditions> tags.
Always include the sample values for each column in the conditions.
The sample values are provided to understand how the data is formatted.
Just because a value isn’t in the sample doesn’t mean it isn’t in the full dataset.

Limit your conditions to the following template:

<conditions>
Filter: Using column X (sample values: a, b, c)
Filter: Using column Y (sample values: a, b, c)
JOIN: Joining column X (sample values a, b, c) and column Y (sample values: a, b, c)
...
</conditions>

If not using filters or JOIN, simply return <conditions>None</conditions>.
3. Finally, follow the VQL rules and return the valid VQL query in between <vql></vql> tags. If a valid VQL query cannot be generated from the provided schema, return <vql>None</vql>.

Limit your response to:
    - Break down the query generation process and give an example of what the expected output set would look like and the granularity of the relevant tables in 75 words, in between <thoughts></thoughts> tags.
    - The filter/JOIN conditions in between <conditions></conditions> tags.
    - The VQL query in between <vql></vql> tags."

QUERY_FIXER = "You are a VQL query language expert.
Here are the VQL generation rules:
<vql_rules>
{vql_restrictions}
</vql_rules>

Here is a VQL query:
<vql_query>
{query}
</vql_query>

Here is the schema for the tables present in the VQL query:
<schema>
{schema}
</schema>

This VQL did not work and failed with error:
<query_error>
{query_error}
</query_error>

This was the thought process behind the generation of the previous VQL:
<query_explanation>
{query_explanation}
<query_explanation>

This query was generated to answer the following question:
<question>
{question}
</question>

Analyze the error, check the VQL rules again and fix the query to correctly answer the question.

Limit your response to:
    - Your thought process in 50-100 words on why the query failed and how to fix it based on the VQL rules provided and the expected answer from the question, in between <thoughts></thoughts> tags.
    - The fixed VQL query in between <vql></vql> tags."

QUERY_REVIEWER = "You are a VQL query language expert.

{vql_restrictions}

Here is a VQL query:
<vql_query>
{query}
</vql_query>

Here is the relevant schema. Pay special attention to column types and the sample values (if available) to understand the schema:
<schema>
{schema}
</schema>

The sample values are provided to understand how the data is formatted.
Just because a value isn’t in the sample doesn’t mean it isn’t in the full dataset.

This query was generated to answer the following question:
<question>
{question}
</question>

However, after execution the query returned no rows.

Your task is to analyze the given VQL query, the schema, and the user question.
Your goal is to determine why the query returned no rows.

If the VQL query returned no rows because of a fixable error, return a new, fixed VQL query.
If the VQL query doesn't appear to contain any fixable errors, simply answer <vql>OK</vql>.

# Common errors
1. When filtering, make sure the filter matches the format in the sample values of the column. 
For example, you want to filter by phone number: 670-000-0000 but sample values show that the phones are formatted without hyphens,
you should remove the hyphens.

2. When performing a JOIN, make sure the format of the values on both sides of the JOIN match.
For example, if one side of the JOIN has strings in capital letters and the other side has strings in lowercase letters.
Don't worry about JOINs with columns of different types, that is handled automatically. Only worry about different format.

# Important Considerations
Always preserve the original intent. Any modifications to the query must stay true to the original question.
Example (Incorrect Change):
Question: \"How many departments have more than 10 employees?\"
Incorrect Fix: Changing the condition to >= 10 (the question asks for more than 10, not 10 or more).
Correct Fix: Identify if the schema allows answering the question differently, such as aggregating data differently.

Limit your response to:
    - Your thought process in 50-65 words on why the query returned no rows, in between <thoughts></thoughts> tags.
    - The new VQL query in between <vql></vql> tags. If the original query makes sense, simply answer <vql>OK</vql>."

FIX_LIMIT = "This VQL query is using LIMIT/FETCH inside a subquery, but my SQL engine doesn't allow LIMIT or FETCH to be used inside a subquery.
CTE is also considered a subquery.

Generate an equivalent VQL query that doesn't use LIMIT or FETCH in a subquery. To solve this, use ROW_NUMBER().

This is the query:
<vql_query>
{query}
</vql_query>

Here is the schema for the tables present in the VQL query:
<schema>
{schema}
</schema>

This query was generated to answer the following question:
<question>
{question}
</question>

Limit your response to:
- The new query in between <vql></vql> tags."

FIX_OFFSET = "This VQL query is using LIMIT OFFSET, but my SQL engine doesn't allow LIMIT OFFSET, only LIMIT.

Generate an equivalent VQL query that doesn't use LIMIT OFFSET. To solve this, use ROW_NUMBER().

This is the query:
<vql_query>
{query}
</vql_query>

Here is the schema for the tables present in the VQL query:
<schema>
{schema}
</schema>

This query was generated to answer the following question:
<question>
{question}
</question>

Limit your response to:
- The new query in between <vql></vql> tags."

ANSWER_VIEW = "
You are Denodo's helpful database agent.
The user has asked a question regarding its database and an execution result has been received.

You will receive the user's question and the execution result of the SQL query. Answer the user's question
using only the information provided in the execution result. You do not have the ability to correct
the query or to execute it again, but you can suggest the user to do it and point him in the right direction.
You must answer with the information provided in the execution result.
{custom_instructions}

Respect the following guidelines when generating a helpful answer:
    {response_format}
    - Provide clear and direct answers.
    - Avoid mentioning SQL or database details, as the user is unfamiliar with them.
    - Format numbers appropriately, using currency symbols, percentages, etc., when relevant.
    - If no results are found, explain this and suggest it may be due to the generated SQL query.
    - If an error occurs, highlight it and mention that it may be caused by the generated SQL query.

Here's an example:

<question>Who scored the most goals last year?</question>
<execution_result>{{'player': 'Cristiano Ronaldo', 'goals': 23}}</execution_result>

You could answer something like this:

<final_answer>{response_example}</final_answer>

Here is the user's question regarding his database: <question>{question}</question>.
Here is the execution result of the SQL query: <execution_result>{sql_response}</execution_result>.

Limit your response to:
    - The answer to the user's question in between <final_answer></final_answer> tags."

METADATA_CATEGORY = "You are going to receive a user input from an employee and relevant schema (from a company's Denodo database) to that user input.

    In Denodo databases, some terminology may be different:

    - Tables are called views. Therefore, if the user mentions 'views' simply replace views for tables.
    - Associations are called relationships. Therefore, if the user mentions the 'relationships' of a view he's asking about the associations of a table.
    - A user may refer to the a set of tables as a 'dataset'. In this instance, simply answer regarding that set of tables.
    {custom_instructions}

    Now, your job is to determine how to answer the user input. 
    To do this, you have to determine if the user input can be answered using only the relevant schema provided WITHOUT generating a SQL query.
    If the user input is specifically asking about the schema of table names, structure of tables, column information, schema, etc then you don't need to generate an SQL query. In this case, answer <cat>METADATA</cat>.
    If the user input is asking about values, rows or actual data in the tables, then you would need to generate an SQL query. In this case, answer <cat>OTHER</cat>.

    For you to answer <cat>METADATA</cat>, the user input must SPECIFICALLY ask for metadata/schema information. For example:

    - What views do we have related to this topic?
    - What is the structure of this table?
    - What relationships does this table have?
    - What datasets do we have?
    - What data do we have?

    These would be METADATA questions. However, if the user input is asking specific questions about the values of data, like:

    - What is the list of products?
    - What doctors are there?

    Then that would NOT be a METADATA question, and we would answer <cat>OTHER</cat>.

    Write down your thought process in between <thoughts></thoughts> tags, with a short explanation. For example:

    <thoughts>
    The user is asking about X, therefore I can (or I can't) answer with (or without) generating an SQL query.
    </thoughts>

    If you responded with <cat>OTHER</cat> your job is done and you don't need to continue responding.
    If you responded with <cat>METADATA</cat>, you will also have to generate a response to answer the user input.
    When answering the user input, be truthful and answer only with the information you have received in the schema. Do not speculate.
    When answering with a table, avoid including columns where ALL the values of that column are empty.

    Always answer in markdown format:
        - Structure your answer in a way that it's readable and visually easy to understand.
        - Use bold, italics and tables in markdown when appropriate to better illustrate the response.
        - You cannot use markdown headings, instead use titles in bold to separate sections, if needed.

    Return the answer in between <response></response> tags. 

    Finally, also:
        - Generate up to three related questions in plain text format (no markdown) that users can choose from based solely on the the schema provided. Ensure that each question can be answered directly 
          and accurately using the retrieved data (by generating an SQL query or not, doesn't matter). Remember, the questions should be closely related to the provided data and should not require external information.
        - Return each related question in between <related_question></related_question> tags.

    Here is the user input: <input>{instruction}</input>.
    Here is the schema: <schema>{schema}</schema>.

    Limit your response to:
        - Your thought process (in maximum 2 lines) of what category to choose in between <thoughts></thoughts>.
        - The category of the user input in between <cat></cat> tags.
        - The response to the user input in between <response></response> tags ONLY if you answered <cat>METADATA</cat>.
        - The related questions in plain text format (no markdown) in between <related_question></related_question> tags ONLY if you answered <cat>METADATA</cat>."

SQL_CATEGORY = "You are going to receive a user input from an employee and relevant schema (from a company's Denodo database) to that user input.

    In Denodo databases, some terminology may be different:

    - Tables are called views. Therefore, if the user mentions 'views' simply replace views for tables.
    - Associations are called relationships. Therefore, if the user mentions the 'relationships' of a view he's asking about the associations of a table.
    - A user may refer to the a set of tables as a 'dataset'.
    {custom_instructions}

    Your job is to determine if the user input can:
    - Can be answered directly WITHOUT generating a SQL query. In this case, respond <cat>OTHER</cat>.
    - Has to be answered by generating a SQL query over the relevant tables. In this case, respond <cat>SQL</cat>.

    If you responded <cat>OTHER</cat> your job is done and you don't need to continue responding.
    If you responded <cat>SQL</cat>, then follow these steps:
    Given the user input and the schema you received, you must prepare
    a brief guideline on how to prepare a valid query to answer the question.
    The tables in the schema come in the format: <database>.<table_name>. You have to respect this format always. 

    Your job is to analyze the user input, analyze the schema and order the tables from most relevant to the question
    to least relevant and return the most relevant tables.

    Return each relevant table in between <table></table> tags.

    For example, for database 'company' and tables 'clients' and 'consumers':

    <table>company.clients</table>
    <table>company.consumers</table>

    Once you have the tables ready, you must specify what SQL knowledge the user will need to
    generate an SQL query for the given input. For each applicable item below, include the corresponding tag with value 1.

    - DATES. Is the query going to need to work with dates? Answer <dates>1</dates>. If not, don't answer anything.
    - ARITHMETIC. Is the query going to need to perform arithmetic? Answer <arithmetic>1</arithmetic>. If not, don't answer anything.
    - SPATIAL. Is the query going to use spatial/geospatial functions? Answer <spatial>1</spatial>. If not, don't answer anything.
    - AI. Is the query going to leverage AI functions (e.g., CLASSIFY_AI, ENRICH_AI)? Answer <ai>1</ai>. If not, don't answer anything.
    - JSON. Is the query going to use JSON functions? Answer <json>1</json>. If not, don't answer anything.
    - XML. Is the query going to use XML functions? Answer <xml>1</xml>. If not, don't answer anything.
    - TEXT. Is the query going to use advanced text/string functions? Answer <text>1</text>. If not, don't answer anything.
    - AGGREGATE. Is the query going to use advanced aggregation functions beyond standard SQL? Answer <aggregate>1</aggregate>. If not, don't answer anything.
    - CAST. Is the query going to require casting considerations? Answer <cast>1</cast>. If not, don't answer anything.
    - WINDOW. Is the query going to use window functions? Answer <window>1</window>. If not, don't answer anything.

    Return your guidelines inside <query></query> tags. Like this:
    <query>
    <table>...</table>
    <table>...</table>
    <dates>1</dates>
    <arithmetic>1</arithmetic>
    </query>

    Here is the user input: <input>{instruction}</input>.
    Here is the schema: <schema>{schema}</schema>.

    Limit your response to:
        - Your thought process (in maximum 2 lines) behind what category to classify the user input as in between <thoughts></thoughts> tags.
        - Category of the user input in between <cat></cat> tags.
        - Tables needed and query classification in between <query></query> tags, if you answered <cat>SQL</cat>."

GENERATE_VISUALIZATION = "
    <purpose>
    You are a Python Matplotlib data visualization expert.
    You will receive the user's request and the execution data related to the user's request.
    You are going to write Python code to generate a visualization using ONLY matplotlib.
    You will receive a predefined template that handles imports, setup, and SVG generation.
    You must write efficient, concise code, without comments. 
    Your goal is to generate an interesting visualization in the least amount of lines possible, while remaining insightful.
    Your task is to write ONLY the core visualization code between <python></python> tags.
    </purpose>

    <template>
    The predefined template already includes:
    - All necessary imports, like Pandas, Numpy, Matplotlib...
    - Sets the matplotlib backend to 'Agg'
    - A 'family_fonts' variable with the required font families. You must load the entire list to have fallbacks for Chinese, Japanase, Korean, Thai, Arabic alphabets.
    - The data already available as a Pandas DataFrame named 'data' in the local scope
    - SVG generation and base64 encoding code
    </template>

    <data_structure>
    Here are the first rows of the 'data' DataFrame:

    {sample_data}

    The statistics about the data and its columns:

    {sample_data_stats}
    </data_structure>

    <guidelines>
    - Always scale and format units. For example, if you have the Y axis representing millions of dollars, you must represent it like 1.5M instead of 1.5e6
    - Your code should create a visualization that gives insight into the data.
    - Use the provided fig and ax objects instead of plt global functions to avoid race conditions:
        - Use ax.plot(), ax.bar(), ax.scatter(), etc. instead of plt.plot(), plt.bar(), plt.scatter()
        - Use ax.set_title(), ax.set_xlabel(), ax.set_ylabel() instead of plt.title(), plt.xlabel(), plt.ylabel()
        - Use fig.suptitle() for main titles if needed
    - Visualization should be clear and easy to understand.
    - Never hardcode values in the Python code, you must obtain everything from the 'data' dataFrame.
    – When possible, remember to order the values in the axis accordingly. For example, if the axis represents time (e.g., months, quarters, years),
    ensure the values follow chronological order rather than alphabetical. Similarly, for categorical data like user segments or performance tiers,
    arrange them in a logical or meaningful sequence (e.g., 'Low', 'Medium', 'High') to improve interpretability and flow.

    - RTL Language Support (e.g., Arabic, Hebrew): If the data labels or requested language suggests Right-to-Left rendering, apply these additional adjustments:
        1. Invert the horizontal axis (X-axis) using ax.invert_xaxis() so that sequences flow from right to left.
        2. Move the vertical axis (Y-axis) ticks and labels to the right side using ax.yaxis.tick_right() and ax.yaxis.set_label_position('right').
        3. Consider aligning the title to the right using ax.set_title(..., loc='right').
    </guidelines>

    <python_template>
    import io
    import json
    import base64
    import matplotlib
    import numpy as np
    import pandas as pd

    matplotlib.use('Agg')
    import matplotlib.pyplot as plt

    plt.rcParams['font.family'] = ['Tahoma', 'Amiri', 'DejaVu Sans', 'Arial', 'SimSun', 'Noto Sans', 'Arial Unicode MS', 'MS Gothic']

    fig, ax = plt.subplots(figsize=(6, 4))

    # YOUR CODE WILL GO HERE

    fig.tight_layout()
    my_stringIObytes = io.BytesIO()
    fig.savefig(my_stringIObytes, format='svg', bbox_inches='tight')
    my_stringIObytes.seek(0)
    base64_string = base64.b64encode(my_stringIObytes.read()).decode()
    print(f'data:image/svg+xml;base64,{{base64_string}}')
    plt.close(fig)
    </python_template>

    <user_requests>
    {instruction}
    </user_request>

    <plot_details>
    {plot_details}
    </plot_details>

    Limit your response to:
        - ONLY the core visualization Python code (NOT the full template) in between <python> and </python> tags."

GENERATE_VISUALIZATION_PYTHON_TEMPLATE = "
import io
import json
import base64
import matplotlib
import warnings
import pandas as pd
import numpy as np

matplotlib.use('Agg')
# Suppress all warnings from matplotlib
warnings.filterwarnings('ignore', category=UserWarning, module='matplotlib')
import matplotlib.pyplot as plt

plt.rcParams['font.family'] = ['Tahoma', 'Amiri', 'DejaVu Sans', 'Arial', 'SimSun', 'Noto Sans', 'Arial Unicode MS', 'MS Gothic']
fig, ax = plt.subplots(figsize=(6, 4))

{python_code}

fig.tight_layout()
my_stringIObytes = io.BytesIO()
fig.savefig(my_stringIObytes, format='svg', bbox_inches='tight')
my_stringIObytes.seek(0)
base64_string = base64.b64encode(my_stringIObytes.read()).decode()
print(f'data:image/svg+xml;base64,{{base64_string}}')
plt.close(fig)"

DIRECT_SQL_CATEGORY = "You are going to receive a user input from an employee and relevant schema (from a company's Denodo database) to that user input.

    In Denodo databases, some terminology may be different:

    - Tables are called views. Therefore, if the user mentions 'views' simply replace views for tables.
    - Associations are called relationships. Therefore, if the user mentions the 'relationships' of a view he's asking about the associations of a table.
    - A user may refer to the a set of tables as a 'dataset'.
    {custom_instructions}

    Given the user input and the schema you received, you must prepare
    a brief guideline on how to prepare a valid query to answer the question.
    The tables in the schema come in the format: <database>.<table_name>. You have to respect this format always. 

    Your job is to analyze the user input, analyze the schema and order the tables from most relevant to the question
    to least relevant and return the most relevant tables.

    Return each relevant table in between <table></table> tags.

    For example, for database 'company' and tables 'clients' and 'consumers':

    <table>company.clients</table>
    <table>company.consumers</table>

    Once you have the tables ready, you must specify what SQL knowledge the user will need to
    generate an SQL query for the given input. For each applicable item below, include the corresponding tag with value 1.

    - DATES. Is the query going to need to work with dates? Answer <dates>1</dates>. If not, don't answer anything.
    - ARITHMETIC. Is the query going to need to perform arithmetic? Answer <arithmetic>1</arithmetic>. If not, don't answer anything.
    - SPATIAL. Is the query going to use spatial/geospatial functions? Answer <spatial>1</spatial>. If not, don't answer anything.
    - AI. Is the query going to leverage AI functions (e.g., CLASSIFY_AI, ENRICH_AI)? Answer <ai>1</ai>. If not, don't answer anything.
    - JSON. Is the query going to use JSON functions? Answer <json>1</json>. If not, don't answer anything.
    - XML. Is the query going to use XML functions? Answer <xml>1</xml>. If not, don't answer anything.
    - TEXT. Is the query going to use advanced text/string functions? Answer <text>1</text>. If not, don't answer anything.
    - AGGREGATE. Is the query going to use advanced aggregation functions beyond standard SQL? Answer <aggregate>1</aggregate>. If not, don't answer anything.
    - CAST. Is the query going to require casting considerations? Answer <cast>1</cast>. If not, don't answer anything.
    - WINDOW. Is the query going to use window functions? Answer <window>1</window>. If not, don't answer anything.

    Return your guidelines inside <query></query> tags. Like this:
    <query>
    <table>...</table>
    <table>...</table>
    <dates>1</dates>
    <arithmetic>1</arithmetic>
    </query>

    Here is the user input: <input>{instruction}</input>.
    Here is the schema: <schema>{schema}</schema>.

    Limit your response to:
        - Tables needed and query classification in between <query></query> tags."

DIRECT_METADATA_CATEGORY = "You are going to receive a user input from an employee and relevant schema (from a company's Denodo database) to that user input.

    In Denodo databases, some terminology may be different:

    - Tables are called views. Therefore, if the user mentions 'views' simply replace views for tables.
    - Associations are called relationships. Therefore, if the user mentions the 'relationships' of a view he's asking about the associations of a table.
    - A user may refer to the a set of tables as a 'dataset'. In this instance, simply answer regarding that set of tables.
    {custom_instructions}

    You must answer the user input given the schema supplied to you.
    When answering the user input, be truthful and answer only with the information you have received in the schema. Do not speculate.

    Always answer in markdown format:
        - Structure your answer in a way that it's readable and visually easy to understand.
        - Use bold, italics and tables in markdown when appropiate to better illustrate the response.
        - You cannot use markdown headings, instead use titles in bold to separate sections, if needed.

    Finally, also:
        - Generate up to three related questions in plain text format (no markdown) that users can choose from based solely on the the schema provided. Ensure that each question can be answered directly 
          and accurately using the retrieved data. Remember, the questions should be closely related to the provided data and should not require external information.
        - Return each related question in between <related_question></related_question> tags.

    Here is the user input: <input>{instruction}</input>.
    Here is the schema: <schema>{schema}</schema>.

    Limit your response to:
        - The response to the user input in between <response></response> tags.
        - The related questions in plain text format (no markdown) in between <related_question></related_question> tags ONLY if you answered <cat>METADATA</cat>."

RELATED_QUESTIONS = "
Generate up to three related questions in plain text format (no markdown) that users can choose from
based solely on the SQL schema supplied. Ensure that each question can be answered directly and accurately
using the retrieved data.

{custom_instructions}

Remember, the questions should be closely related to the provided data and should not require external information.
Return each related question in between <related_question></related_question> tags, like this:

<related_question>...<related_question>
...
<related_question>...</related_question>

If the schema supplied is empty or the execution result is an error/empty, only return:

<N>

Here is the SQL schema for this query: <schema>{schema}</schema>.
Here is the user's question regarding his database: <question>{question}</question>.
Here is the execution result of the SQL query: <execution_result>{sql_response}</execution_result>.

Limit your response to:
    - The related questions, each question in between <related_question></related_question> tags."

SPATIAL_VQL = "
Apart from the spatial functions from the SQL Standard (SQL/MM Spatial / OGC SFA), VQL also supports these:

    - ST_AREA_METERS(wkb, code). This function returns the area of wkb. The units of the result are square meters. The code identifies the CRS of the geometry.
    - ST_BUFFER_METERS(wkt, code, <distance:double>). Returns a new geometry that covers all points within a given distance from the input geometry. The code identifies the CRS of the geometry. The unit of distance is meters.
    - ST_CREATE_POINT(<x:DOUBLE>, <y:DOUBLE). Creates a point, the parameters are the abscissa(x) and the ordinate(y), which define the location of a point in two-dimensional rectangular space.
    - ST_DISTANCE_METERS(wkb1|wkt1, code1, wkb2|wkt1, code2). Returns the minimum distance between the geometry wkb1/wkt1 and the geometry wkb2/wkt2 expressed in meters. The codes identify the CRS of each geometry.
    
        If any of the CRS of the inputs are different to WGS84, then they are projected to WGS84, and when the two geometries are in WGS84, the orthodromic distance between the two geometries is calculated.
        For example:
            ST_DISTANCE_METERS('POINT(43.37 -8.41)','EPSG:4326', 'POINT(43.50 -8.22)','EPSG:4326')
            ST_DISTANCE_METERS('POINT(547800.41 4802073)','EPSG:32629', 'POINT (563058.68 4816636.85)','EPSG:32629')

            These examples are equivalents, their operation is on the two same points, expressed in WGS84 and in UTM zone 29N respectively, and the result will be:

            21100.76

    - ST_GEOM_TO_STRUCT(wkb|wkt). Parses a blob (if wkb) or text (if wkt) value that represents a geometry and converts it into a structural representation of the geometry in terms of register and arrays.
    - ST_LENGTH_METERS(wkb, <code:string>). Returns the length of wkb/wkt, the units of the result are meters.
    - ST_TRANSFORM(wkb, <source_code:string>, <target_code:string). Transforms a geometry from one CRS to another CRS.
    - ST_WKBTOWKT(wkb). Transforms a well-known binary (wkb) into a well-known text (wkt).
    - ST_WKTTOWKB(wkt). Transforms a well-known text (wkt) into a well-known binary (wkb).

The CRS codes in VQL need to include the authority (usually EPSG), like 'EPSG:1234', 'AUTO:42001'"

AI_VQL = "
VQL supports using AI through the following functions:

    - CLASSIFY_AI(<value:text>, <classification scale:array>): text. Takes a given text and a classification scale as input, and returns an accurate classification based on the content of the text. Example: 
            SELECT 
                    address,
                    CLASSIFY_AI(
                        address, 
                        {
                            row('Number of street between 1-500'),
                            row('Number of street between 501-999'),
                            row('Number of street over 999')
                        }
                    ) AS classification
        FROM organization.customer;
    - ENRICH_AI(<prompt:text>): text. Queries the AI with the provided prompt. For example,
    you can use this to extract information from a column, like this:

        SELECT 
        address,
        ENRICH_AI(
            CONCAT(
                'I need you to extract only the street name from this address: \"',
                address,
                '\"\nLimit your response to just the street name and nothing else, like \"Philips St\"'
            )
        ) AS street
        FROM enterprise.customer;

    - ENRICH_AI_BINARY(<text prompt>, <binary blob>, <content type text>):text. Queries the AI with the provided prompt and an image or a PDF document.
    - EXTRACT_AI(<value:text>, <entityArray:array>):register. Identifies and extracts the most relevant occurrence of specified entities from a given text. Given the input text and specified entities, the function uses AI to determine and return the most accurate and contextually appropriate matches.
    - SENTIMENT_AI(<value:text> [, <custom sentiments:array> ]):text. Analyzes the sentiment of the provided text input by querying the AI to check if the sentiment is negative, neutral, mixed or positive.
    - SUMMARIZE_AI(<value:text> [, <word length:int>]):text. Generates automatic summaries with AI.
    - TRANSLATE_AI(<value:text>, <target language:text> [, <origin language:text>]):text. Performs language translation with AI."

JSON_VQL = "
JSON functions:

    - AVRO_TO_JSON(<AVRO document:blob>, <JSON schema:text>):text. Returns a JSON document from an AVRO document and a JSON schema.
    - JSON_TO_AVRO(<JSON document:text>, <JSON schema:text>):blob. Returns an AVRO document from a JSON document and a schema.
    - COMPLEX_TYPE_TO_JSON(<array value:array>, <JSON document:text>):text. Converts a register or an array to a text value with a JSON document.
    - JSON_TO_COMPLEX_TYPE(<JSON document:text>, <JSON schema:text>):text. Converts a JSON expression to a register complex type.
    - JSONPATH(<JSON document:text>, <JSONPath expression:text> [, jsonOutput:boolean]):text. Returns the nodes from a JSON document selected by a JSONPath expression."

XML_VQL = "
XML functions:

    - XMLQUERY(<XQuery expression:text> [, <is XQuery file:boolean>] [, <xml value:text>] [, <is XML file:boolean>]):xml. Extracts information from an XML document using the XQuery language.
    - XPATH(<xml value:xml>, <XPath expression:text> [, <xml header:boolean> ]):xml. Selects nodes from an XML document based on an XPath expression.
    - XSLT( <XML value:{xml|text}>, <xslValue:{xml|text}>, [, <is path to XML:boolean> ] [, <is path to XSLT:boolean> ]:xml. Returns the result of applying an XSL transformation to an XML."

TEXT_VQL = "
VQL supports the standard SQL text functions. It also supports the following ones:

    - ASCII(string_expression)
    - BASE64_TO_BASE10(string_expression)
    - BASE64_TO_HEX(string_expression)
    - CHAR_LENGTH(string_expression)
    - CONCATLIST(string_column)
    - DELETESPACES(string_expression)
    - ENDWITH(string_expression, substring)
    - HEX_TO_BASE64(string_expression)
    - INITCAP(string_expression)
    - INSTR(string_expression, substring, [start_position], [nth_occurrence])
    - LEFT(string_expression, number_of_characters)
    - LEFTPAD(string_expression, total_length, [pad_character])
    - LEN(string_expression)
    - PRINTF(format_string, ...)
    - PROPERCASE(string_expression)
    - REGEXP(string_expression, pattern)
    - REGEXP_COUNT(string_expression, pattern)
    - REMOVEACCENTS(string_expression)
    - REPLACEMAP(string_expression, mapping_definition)
    - RIGHT(string_expression, number_of_characters)
    - RIGHTPAD(string_expression, total_length, [pad_character])
    - SIMILARITY(string_expression_1, string_expression_2)
    - SPLIT(string_expression, delimiter)
    - STARTWITH(string_expression, substring)"

AGGREGATE_VQL = "
VQL supports the standard SQL aggregation functions. It also supports the following ones:

    - FIRST(field). Returns the first value of a field of each group of values.
    - LAST(field). Returns the last value of a field of each group of values.
    - LIST(field). Returns an array with all the values of a specified field.
    - MEDIAN(expression:[timetimestamp | timestamptz | numeric]). Returns the middle number of a field for each group of values.
    - NEST(field1 [, fieldN]) or NEST(*). Returns an array with the values of the selected fields.
    - STDEV(expression). Returns the sample standard deviation.
    - STDEVP(expression) Returns the population standard deviation.
    - VAR(expression) Returns the sample variance.
    - VARP(expression) Returns the population variance.
    - The GROUP_CONCAT function returns, for each group, a string with the concatenation of the values of the specified fields. Syntax:
        1. GROUP_CONCAT ([ DISTINCT | ALL ] <field name:identifier> [, <field name:identifier>]...) :text
        2. GROUP_CONCAT ([ <ignore null:boolean> , ] [ <row separator:text> [, <field separator:text> ]], <field name:identifier> [, <field name:identifier>]...) :text
    - UNNEST is not a valid VQL function. Instead use a statement with the VQL FLATTEN operator which projects the array elements as fields.
    The result of the VQL FLATTEN operator is a view with the elements of the array projected as fields.
    Simple datatypes in the array use the name of the datatype itself like string, date or integer as the projected fieldname.

    Valid VQL FLATTEN operator example: FLATTEN \"tablename\" as \"t\" (\"t\".\"arrayfield\")
    (Important: The projected field from the array can not have an alias with the AS operator! This results in an invalid VQL statement).

    Valid VQL example where genre_array is an array with data of type string):
    SELECT
        DISTINCT string AS genre
    FROM
        FLATTEN tvshows.iv_tmdb AS t (t.genre_array);

    Invalid VQL FLATTEN:
    SELECT
        DISTINCT genre
    FROM
        FLATTEN tvshows.iv_tmdb AS t (t.genre_array) AS genre;"

CAST_VQL = "
VQL supports the standard SQL CAST function and the following ones:

    - ARRAY_TO_STRING. Converts an array field to a string that contains the elements of the array separated by a character. Signatures:
        1. ARRAY_TO_STRING(<separator:text>, <array value:array>):text.
        2. ARRAY_TO_STRING(<separator:text>, <array begin delimiter:text>, <array end delimiter:text>, <register begin delimiter:text>,<register end delimiter:text>, <array value:array> ):text
    - CREATETYPEFROMXML(<new type name:text>, <xml value:{xml|text}>):text. Creates a register or an array type from XML data. If the type is created correctly, it returns the name of the new type.
        Example: SELECT CREATETYPEFROMXML('title_type',
                '<titles>
                    <title lang=\"en\">XQuery Kick Start</title>
                    <title lang=\"en\">Learning XML</title>
                </titles>') FROM Dual();
    - REGISTER(<field name:any type> [, <field name:any type> ]*):register. Creates a register with the values of the fields of a view.
        Example of a register: Register {1, A, Register {hello , how’re you}}."

WINDOW_VQL = "
Apart from the ones from the SQL standard, VQL supports these window functions:

    - LISTAGG (<measure expression>, <delimiter expression:text>) WITHIN GROUP (<window order by clause>) OVER ([<window partition clause> ]):text. Orders data within each group specified in the clause ORDER BY and then, concatenates the values of the measure column. It separates each value with the “delimiter expression”.
    - STDEV(<expression>) OVER ([<window partition clause>] [<window order by clause>]):number. Computes the statistical sample standard deviation of the current row with respect to the group within a window."